<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.team1.project.dao.UsDAO">

<!-- 전체목록조회 -->
<!-- <select id="getUsList" resultType="com.team1.project.dto.UsDTO"> -->
<!--       SELECT * FROM ( -->
<!--           SELECT rownum AS nrow, us_num, city_name, writer, us_cnt, regdate, start_Date, end_Date, title, content -->
<!--           FROM (  -->
<!--               SELECT rownum  AS nrow, us_num, city_name, writer, us_cnt, regdate, start_Date, end_Date, title, content -->
<!--               FROM us a  -->
<!--               WHERE rownum BETWEEN #{startNo} AND #{endNo} -->
<!--               order by us_num desc -->
<!--          <if test="start_Date != null and end_Date != null"> -->
<!--              AND (end_Date <![CDATA[<=]]> #{end_Date} AND start_Date <![CDATA[>=]]> #{start_Date}) -->
<!--          </if> -->
<!--           ) -->
<!--       ) WHERE nrow BETWEEN #{startNo} AND #{endNo} -->
<!-- </select> -->

<!-- 전체목록조회 -->
<select id="getUsList" resultType="com.team1.project.dto.UsDTO">
    SELECT * FROM (
        SELECT rownum AS nrow, us_num, city_name, writer, us_cnt, regdate, start_Date, end_Date, title, content
        FROM (
            SELECT rownum  AS nrow, us_num, city_name, writer, us_cnt, regdate, start_Date, end_Date, title, content
            FROM us a 
            WHERE rownum BETWEEN #{startNo} AND #{endNo}
            <!-- start_Date와 end_Date에 대한 조건이 있는 경우 -->
            <if test="start_Date != null and end_Date != null">
                AND (end_Date <![CDATA[<=]]> #{end_Date} AND start_Date <![CDATA[>=]]> #{start_Date})
            </if>
            <!-- 페이징과 조건이 모두 적용된 경우 ORDER BY 추가 -->
            <if test="start_Date != null and end_Date != null">
                ORDER BY us_num DESC
            </if>
        )
    ) WHERE nrow BETWEEN #{startNo} AND #{endNo}
</select>


<!-- 메인 탑5 노출 -->
<select id="usTop5" resultType="com.team1.project.dto.UsDTO">
	<![CDATA[
 		SELECT 
 			ROWNUM AS nrow, SUB.* 
 		FROM (  
 			SELECT  
 				US_NUM, CITY_NAME, WRITER, US_CNT, REGDATE, START_DATE, END_DATE, TITLE, CONTENT 
 			FROM us  
 			ORDER BY us_num DESC 
 		) SUB   
 		WHERE ROWNUM <= 5 
 	]]> 
</select>

<!-- 전체 게시글 수 -->
<select id="totalCount" resultType="int">
		select count(*)
		from us
 	</select>

<!-- 동행 글쓰기 -->
    <insert id="writeInsert"> 
    INSERT INTO us ( 
        US_NUM, CITY_NAME, WRITER, US_CNT, START_DATE, END_DATE, TITLE , CONTENT
    ) VALUES ( 
        #{us_num}, #{city_name}, #{writer}, #{us_cnt},  #{start_Date}, #{end_Date}, #{title}, #{content} 
    )
</insert>

<!-- 상세보기 -->
    <select id="usDetail" resultType="com.team1.project.dto.UsDTO">
    SELECT 
    	US_NUM, CITY_NAME, WRITER, US_CNT, START_DATE, END_DATE, TITLE, CONTENT
    FROM US 
    WHERE US_NUM = #{us_num}
 </select> 

<!-- 수정하기 -->
   <update id="usUpdate"> 
    UPDATE US 
    SET 
    CITY_NAME = #{city_name},
    WRITER = #{writer}, 
    US_CNT = #{us_cnt}, 
    START_DATE = #{start_Date}, 
    END_DATE = #{end_Date}, 
    TITLE = #{title}, 
    CONTENT = #{content} 
    WHERE US_NUM = #{us_num} 
</update> 
   
<!-- 삭제하기  -->
    <delete id="usDelete"> 
         DELETE FROM US 
         WHERE US_NUM = #{us_num} 
     </delete> 
     
     
     <!-- 최신 동행 모집글 -->
		<select id="getUsRecentList" resultType="com.team1.project.dto.UsDTO">
		    SELECT * FROM (
		        SELECT * FROM us
		        ORDER BY regdate DESC
		    )
		    WHERE ROWNUM &lt;= 3
		</select>
<!-- 관리자 -->
<!-- 신고받은 동행 리스트 가져오기 -->
	<select id="usList" parameterType="com.team1.project.dto.UsDTO" resultType="com.team1.project.dto.UsDTO">
		SELECT * from us where reportcnt > 0 ORDER BY STATUS desc
	</select>
<!-- 신고받은 동행 리스트 차트 연습용 -->
	<select id="usReportList" parameterType="com.team1.project.dto.UsDTO" resultType="com.team1.project.dto.UsDTO">
	  <![CDATA[
	    SELECT TO_CHAR(regdate, 'YYYY-MM-DD') AS regdate, COUNT(*) AS post_count, reportcnt
	    FROM US
	    WHERE reportcnt >= 1
	    GROUP BY TO_CHAR(regdate, 'YYYY-MM-DD'), reportcnt
	    ORDER BY regdate
	  ]]>
	</select>
	
<!-- 관리자 동행 게시글 삭제 처리 -->
	<update id="ausDelete">
		UPDATE us
		SET status = 'Y'
		WHERE us_num = #{us_num}
	</update>
	
<!-- 관리자 동행 게시글 복구 -->
	<update id="ausChange">
		UPDATE us
		SET status = 'N'
		WHERE us_num = #{us_num}
	</update>
</mapper>
